#!/bin/sh

bypassipvs4s=$(ipset -o save list omr_dst_bypass_srv_vpn1_4)
[ -z "$bypassipvs4s" ] && bypassipv4s=$(nft -j list set inet fw4 "omr_dst_bypass_srv_vpn1_4" | jsonfilter -e @.nftables[1].set.elem[*].prefix | awk '{gsub(/"/,"",$3);gsub(/,/,"/",$3); print $3 $5}')
bypassipvs6s=$(ipset -o save list omr_dst_bypass_srv_vpn1_6)
[ -z "$bypassipvs6s" ] && bypassipv6s=$(nft -j list set inet fw4 "omr_dst_bypass_srv_vpn1_6" | jsonfilter -e @.nftables[1].set.elem[*].prefix | awk '{gsub(/"/,"",$3);gsub(/,/,"/",$3); print $3 $5}')
#"
vpnipv4md5=$(echo "${bypassipv4s}" | md5sum | awk '{print $1}' | tr -d "\n")
vpnipv6md5=$(echo "${bypassipv6s}" | md5sum | awk '{print $1}' | tr -d "\n")
if [ "$vpnipv4md5" != "$(uci -q get omr-bypass.global.vpn_ipv4_md5)" ] || [ "$vpnipv6md5" != "$(uci -q get omr-bypass.global.vpn_ipv6_md5)" ]; then
	_log "Set bypass ip on servers"
	/etc/init.d/openmptcprouter-vps set_bypass_ips
	uci -q batch <<-EOF >/dev/null
		set omr-bypass.global=global
		set omr-bypass.global.vpn_ipv4_md5=${vpnipv4md5}
		set omr-bypass.global.vpn_ipv6_md5=${vpnipv6md5}
		commit omr-bypass
	EOF
fi
